name: Build and Deploy Frontend

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
# oidc is required for azure/login action and add federation identity credential Subject to the service principal in azure portal and set it to repo:<OWNER>/<REPO>:ref:refs/heads/main
env:
  AZURE_CLIENT_ID: '43407652-d41c-402c-95d3-97711c0557c2'
  AZURE_TENANT_ID: 'd6c5bbe2-0dd0-4148-a86c-ffe8f3e95c29'
  AZURE_SUBSCRIPTION_ID: '4951b3fd-2793-4851-80ff-a11f2814093c'

  RESOURCE_GROUP: 'sfmtest'
  CLUSTER_NAME: 'aks-myapp-prod'
  ACR_NAME: 'sfmappregistry'
  IMAGE_NAME: 'sfmfrontendimage'


jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login (OIDC)
      uses: azure/login@v2
      with:
        client-id: ${{ env.AZURE_CLIENT_ID }}
        tenant-id: ${{ env.AZURE_TENANT_ID }}
        subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

    - name: üê≥ Login to ACR
      run: az acr login --name ${{ env.ACR_NAME }}

    - name: üî® Build Frontend Image
      run: |
        IMAGE_TAG=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker build -t $IMAGE_TAG .
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV


    - name: üì§ Push Image
      run: docker push ${{ env.IMAGE_TAG }}

    - name: ‚ò∏Ô∏è Set AKS Context
      uses: azure/aks-set-context@v4
      with:
        resource-group: ${{ env.RESOURCE_GROUP }}
        cluster-name: ${{ env.CLUSTER_NAME }}

    - name: üöÄ Deploy Frontend to AKS
      uses: azure/k8s-deploy@v5
      with:
        namespace: sfm
        manifests: |
          K8s/frontend-deployement.yaml
          K8s/frontend-service.yaml
        images: |
          ${{ env.IMAGE_TAG }}


    - name: ‚úÖ Verify
      run: |
        kubectl get pods -n sfm -l app=sfm-frontend
        kubectl get svc -n sfm sfm-frontend-service
